<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <style>
    /* Minimal styling for demonstration */
    .tabs-container {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .tab {
      background: #497ea5;
      color: #000;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .tab.active {
      background: #006fa1;
      color: #fff;
      font-weight: bold;
    }
    .tab-close {
      margin-left: 8px;
      cursor: pointer;
    }
    .client-card {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
    }
    .client-card h4 {
      margin: 0;
    }
    .activate-btn {
      margin-left: auto;
      cursor: pointer;
      background: #497ea5;
      border: none;
      border-radius: 4px;
      color: #000;
      padding: 6px 12px;
    }
    .activate-btn:hover {
      background: #006fa1;
      color: #fff;
    }
    .active-client-tab {
      display: none;
      border: 1px solid #ccc;
      padding: 8px;
      margin-bottom: 16px;
    }
    .active-client-tab.active {
      display: block;
    }
    .machine-info-table td {
      padding: 4px 8px;
      vertical-align: top;
    }
  </style>
</head>
<body>
  <main>
    <!-- 1) Tabs Section -->
    <div class="tabs-container" id="agent-tabs-container">
      <div class="tab active" data-tab="all-clients" id="allClientsTab">All Clients</div>
    </div>

    <!-- 2) Dynamic Tab Content -->
    <div id="agent-tab-content"></div>

    <!-- 3) Scrollable container for client cards -->
    <div id="clientsContainer"></div>
  </main>

  <script>
    "use strict";

    // We'll store references to frequently accessed elements here
    const domRefs = {
      tabsContainer: document.getElementById("agent-tabs-container"),
      tabContent: document.getElementById("agent-tab-content"),
      clientsContainer: document.getElementById("clientsContainer"),
      allClientsTab: document.getElementById("allClientsTab")
    };

    // Store all tabs/panels in-memory for quick access
    // e.g. { "Machine1": { tabEl: <div>, panelEl: <div> }, ... }
    const clientTabsMap = {};

    // We also keep a chatHistory or similar if needed, but let's focus on machine info for now.

    // 1) On page load, fetch the list of agents and build the cards.
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        const agents = await fetchAgents();
        renderClientCards(agents);
      } catch (err) {
        console.error("Failed to fetch agents:", err);
      }

      // Show all clients if the "All Clients" tab is clicked
      domRefs.allClientsTab.addEventListener("click", showAllClients);
    });

    /**
     * Fetch the agent list from /api/agents (GET).
     * Expected: [{ "HostName": "PC-123", "os": "Windows 10", "Agentid": "Machine1" }, ...]
     */
    async function fetchAgents() {
      const resp = await fetch("/api/agents");
      if (!resp.ok) {
        throw new Error("Failed to fetch agents: " + resp.statusText);
      }
      return resp.json();
    }

    /**
     * Render a card for each agent in the #clientsContainer
     * No innerHTML, we build each card using DOM.
     */
    function renderClientCards(agents) {
      // Clear old data
      domRefs.clientsContainer.textContent = "";

      for (const agent of agents) {
        // Create card
        const card = document.createElement("div");
        card.classList.add("client-card");
        card.dataset.agentId = agent.Agentid; // store the agent's ID

        // Create the heading
        const title = document.createElement("h4");
        title.textContent = agent.HostName;
        card.appendChild(title);

        // OS info (just text, as requested)
        const osInfo = document.createElement("span");
        osInfo.textContent = `OS: ${agent.os}`;
        card.appendChild(osInfo);

        // Activate button
        const activateBtn = document.createElement("button");
        activateBtn.classList.add("activate-btn");
        activateBtn.textContent = "Activate";
        activateBtn.addEventListener("click", () => activateClient(agent));
        card.appendChild(activateBtn);

        // Add to container
        domRefs.clientsContainer.appendChild(card);
      }
    }

    /**
     * 2) Activate a client => create a tab + detail panel
     *    Also fetch machine info from /api/modules/collection/machine_info/{Agentid}/basic
     */
    async function activateClient(agent) {
      // If we already have a tab for this agent, just open it
      if (clientTabsMap[agent.Agentid]) {
        openTab(agent.Agentid);
        return;
      }

      // Create a new tab
      const tabEl = document.createElement("div");
      tabEl.classList.add("tab");
      tabEl.dataset.tab = agent.Agentid;
      tabEl.textContent = agent.HostName;

      // Add a close button
      const closeBtn = document.createElement("span");
      closeBtn.classList.add("tab-close");
      closeBtn.textContent = "×";
      closeBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        closeTab(agent.Agentid);
      });
      tabEl.appendChild(closeBtn);

      // Clicking on the tab opens that client's panel
      tabEl.addEventListener("click", () => openTab(agent.Agentid));

      // Insert tab
      domRefs.tabsContainer.appendChild(tabEl);

      // Create detail panel
      const panelEl = document.createElement("div");
      panelEl.classList.add("active-client-tab");
      panelEl.dataset.client = agent.Agentid;

      // We'll eventually fill Machine Info below
      domRefs.tabContent.appendChild(panelEl);

      // Store references
      clientTabsMap[agent.Agentid] = {
        tabEl: tabEl,
        panelEl: panelEl
      };

      // Then fetch the machine info and show it
      try {
        const machineInfo = await fetchMachineInfo(agent.Agentid);
        buildMachineInfoPanel(panelEl, agent.Agentid, machineInfo);
      } catch (err) {
        console.error("Failed to fetch machine info:", err);
      }

      // Open the tab
      openTab(agent.Agentid);
    }

    /**
     * Fetch machine info from /api/modules/collection/machine_info/{Agentid}/basic
     */
    async function fetchMachineInfo(agentId) {
      const resp = await fetch(`/api/modules/collection/machine_info/${agentId}/basic`);
      if (!resp.ok) {
        throw new Error("Failed to fetch machine info: " + resp.statusText);
      }
      return resp.json();
    }

    /**
     * Dynamically build a "Machine Info" table (or any layout) inside the given panelEl.
     * No innerHTML, purely createElement + textContent.
     */
    function buildMachineInfoPanel(panelEl, agentId, info) {
      // Clear old content if any
      while (panelEl.firstChild) {
        panelEl.removeChild(panelEl.firstChild);
      }

      // Title
      const title = document.createElement("h3");
      title.textContent = `${agentId} Machine Info`;
      panelEl.appendChild(title);

      // Build a table
      const table = document.createElement("table");
      table.classList.add("machine-info-table");

      // Helper to create row
      function createRow(label, value) {
        const tr = document.createElement("tr");

        const tdLabel = document.createElement("td");
        tdLabel.textContent = label + ": ";
        tr.appendChild(tdLabel);

        const tdValue = document.createElement("td");
        // If it’s an array (e.g., LogedInSessions), join them
        if (Array.isArray(value)) {
          tdValue.textContent = value.join(", ");
        } else {
          tdValue.textContent = value;
        }
        tr.appendChild(tdValue);

        return tr;
      }

      // Create rows
      table.appendChild(createRow("Hostname", info.HostName));
      table.appendChild(createRow("Operating System", info.OperatingSystem));
      table.appendChild(createRow("OS Version Detail", info.OSVersionDetail));
      table.appendChild(createRow("CPU", info.CPU));
      table.appendChild(createRow("RAM", info.RAM));
      table.appendChild(createRow("Disk", info.Disk));
      table.appendChild(createRow("PrimaryIP", info.PrimaryIP));
      table.appendChild(createRow("GPU", info.GPU));
      table.appendChild(createRow("AgentStatus", info.AgentStatus));
      table.appendChild(createRow("LastLogin", info.LastLogin));
      table.appendChild(createRow("LogedInSessions", info.LogedInSessions));

      panelEl.appendChild(table);
    }

    /**
     * Show All Clients => revert to original card view
     */
    function showAllClients() {
      // Deactivate all tabs
      Object.values(clientTabsMap).forEach(({ tabEl }) => tabEl.classList.remove("active"));
      // Hide all detail panels
      Object.values(clientTabsMap).forEach(({ panelEl }) => panelEl.classList.remove("active"));
      domRefs.allClientsTab.classList.add("active");

      // Show all client cards
      domRefs.clientsContainer.querySelectorAll(".client-card").forEach(card => {
        card.style.display = "flex";
        card.style.border = "";
      });
    }

    /**
     * Open a specific client tab => hide cards, show detail
     */
    function openTab(agentId) {
      // Hide all cards
      domRefs.clientsContainer.querySelectorAll(".client-card").forEach(card => {
        card.style.display = "none";
      });

      // Deactivate other tabs
      domRefs.tabsContainer.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
      // Deactivate other panels
      domRefs.tabContent.querySelectorAll(".active-client-tab").forEach(panel => {
        panel.classList.remove("active");
      });

      // Activate the selected tab
      const tabInfo = clientTabsMap[agentId];
      if (tabInfo) {
        tabInfo.tabEl.classList.add("active");
        tabInfo.panelEl.classList.add("active");
      }
    }

    /**
     * Close the tab
     */
    function closeTab(agentId) {
      // Remove the tab from DOM
      const tabInfo = clientTabsMap[agentId];
      if (tabInfo) {
        domRefs.tabsContainer.removeChild(tabInfo.tabEl);
        domRefs.tabContent.removeChild(tabInfo.panelEl);
        delete clientTabsMap[agentId];
      }

      // Reset the border of the corresponding card
      const card = domRefs.clientsContainer.querySelector('[data-agent-id="' + agentId + '"]');
      if (card) {
        card.style.border = "";
      }

      // Show All Clients
      showAllClients();
    }
  </script>
</body>
</html>
